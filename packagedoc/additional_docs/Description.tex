% Copyright 2020-2022 Robert Bosch GmbH

% Licensed under the Apache License, Version 2.0 (the "License");
% you may not use this file except in compliance with the License.
% You may obtain a copy of the License at

% http://www.apache.org/licenses/LICENSE-2.0

% Unless required by applicable law or agreed to in writing, software
% distributed under the License is distributed on an "AS IS" BASIS,
% WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
% See the License for the specific language governing permissions and
% limitations under the License.

\hypertarget{description-get-robotframework-xml-result}{%
\section{Get \rfwcore\ XML result}
\label{description-get-robotframework-xml-result}}

In order to manage test cases and their results with RQM, some traceable 
information such as version, testcase ID, component, ... are required.

So that the \pkg\ tool can know which importing test results are
belong to (Test Case) or linked with (Build Record, Test Environment) on RQM.

These information should be provided in\rcode{Metadata}(for the whole
testsuite/execution info: version, build, ...) and\rcode{{[}Tags{]}}information 
(for specific testcase info: component, testcase ID, requirement ID, ...) of
\rfwcore\ testcase. 
Then when executing Robot testcase(s), the generated Robot result file (default 
is \emph{output.xml}) will contain all of them and ready for importing.

Sample \rfwcore\ testcase with the neccessary information for importing to RQM:

\begin{robotcode}[caption=Sample \rfwcore\ testcase,
                  linebackgroundcolor=\hlcode{2,3,4}]
*** Settings ***
Metadata   project      ROBFW             # Test Environment on RQM for linking
Metadata   version_sw   SW_VERSION_0.1    # Build Record on RQM for linking
Metadata   machine      %{COMPUTERNAME}   # Hostname attribute in RQM Test Case Result
Metadata   component    Import_Tools      # Component attribute in RQM Test Case
Metadata   team-area    Internet Team RQM  # team-area (case-sensitive) on RQM for linking

*** Test Cases ***
Testcase 01
   [Documentation]   This test is traceable with provided tcid
   [Tags]   TCID-1001   FID-112   FID-111    robotfile-https://github.com/test-fullautomation
   Log      This is Testcase 01

Testcase 02
   [Documentation]  This new testcase will be created if -createmissing argument
               ...  is provided when importing
   [Tags]   FID-113  robotfile-https://github.com/test-fullautomation
   Log      This is Testcase 02
\end{robotcode}

\begin{boxhint} {Hint}
  In case you are using \rfw\ with 
  \href{https://github.com/test-fullautomation/robotframework-testsuitesmanagement}{RobotFramework\_Testsuites}
  library for executing Robot testcase(s). 
  You do not need to define above highlighted\rcode{Metadata}in your Robot test case.

  These\rcode{Metadata}information will be defined implicitly within the 
  \rcode{Suite Setup} bases on your environment and configuration in *.json file.
\end{boxhint}

\hypertarget{description-tool-features}{%
\section{Tool features}\label{description-tool-features}}

After getting the \rfwcore\ \emph{*.xml} result file(s), you can use the \pkg\ tool to
import them into RQM.

Its usage and features are described as following sections.

\subsection{Usage}
Use below command to get tools's usage:
\begin{robotlog}
RobotLog2DB -h
\end{robotlog}

The tool's usage should be showed as below:
\begin{robotlog}
usage: RobotLog2RQM (RobotXMLResult to RQM importer) [-h] [-v] [--recursive] 
                    [--createmissing] [--updatetestcase] [--dryrun] 
                    resultxmlfile host project user password testplan

RobotLog2RQM imports XML result files (default: output.xml) generated by the 
                  Robot Framework into an IBM Rational Quality Manager.

positional arguments:
resultxmlfile     absolute or relative path to the xml result file 
                  or directory of result files to be imported.
host              RQM host url.
project           project on RQM.
user              user for RQM login.
password          password for RQM login.
testplan          testplan ID for this execution.

optional arguments:
-h, --help        show this help message and exit
-v, --version     Version of the RobotLog2RQM importer.
--recursive       if set, then the path is searched recursively for 
                  log files to be imported.
--createmissing   if set, then all testcases without tcid are created 
                  when importing.
--updatetestcase  if set, then testcase information on RQM will be updated 
                  bases on robot testfile.
--dryrun          if set, then verify all input arguments 
                  (includes RQM authentication) and show what would be done.
\end{robotlog}

As above instruction, \pkg\ tool requires 5 positional arguments consists of:
\begin{itemize}
  \item The Robot result file/folder\rlog{resultxmlfile}
  \item The RQM authentication\rlog{host},\rlog{project},\rlog{user},\rlog{password}
  \item The RQM\rlog{testplan}ID which will contains all importing test results
\end{itemize} 

\subsection{Basic import feature}
Use the below command for the simple import the \emph{output.xml} file to RQM 
project \textbf{ROBFW-AIO} which is hosted at 
\href{https://sample-rqm-host.com}{https://sample-rqm-host.com}
\begin{robotlog}
RobotLog2RQM output.xml https://sample-rqm-host.com ROBFW-AIO test_user test_pw 720
\end{robotlog}

When command is executed, the tool will process with following steps:
\begin{itemize}
\item Login the RQM server with the provided credential, tehn verify the 
      existences of given\rlog{project},\rlog{testplan} on RQM
\item Create RQM \textbf{Build Record} and \textbf{Test Environment} (if already 
      provided in Robot test case and not existing on RQM)
\item Create new RQM \textbf{Test Case Execution Record - TCER} 
      (if it is not existing) bases on test case ID (defined \rcode{TCID-xxx} in
      \rcode{[Tags]} of Robot Test Cases) and \rlog{testplan} ID
\item Create new RQM \textbf{Test Case Execution Result} which contents 
      the detail and result state of Robot test case
\item Link all test case(s) to provided \rlog{testplan}
\end{itemize}

\subsection{Verify the given arguments}
In case you just want to verify whether the given \emph{*.xml} file/folder and 
the RQM authentication in arguments are corrected or not, the optional argument
\rlog{--dryrun} will help to do it.
\\
In the dryrun mode, \pkg\ will not create any resources on RQM, it 
just verify:
\begin{itemize}
  \item The given Robot result file/folder is valid or not
  \item The given RQM authentication is correct or not
  \item The given RQM project and testplan are existing or not
\end{itemize}

\subsection{Import multiple *.xml result files}
\pkg\ accepts the first arugment \rlog{resultxmlfile} can be a single file or 
the folder that contains multiple Robot result files.

When the folder is used, \pkg\ will only search for \emph{*.xml} file under 
given directory and exclude any file within subdirectories as default.

In case you have result file(s) under the subdirectory of given folder and want 
these result files will also be imported, the optional arugment
\rlog{--recursive} should be used when executing \pkg\ command.

When \rlog{--recursive} argument is set, \pkg\ will walk through the given 
directory and its subdirectories to discover and collect all available 
\emph{*.xml} for importing.

For example: your result folder has a structure as below:

\begin{robotlog}
logFolder
   |_____ result_1.xml
   |_____ result_2.xml
   |_____ subFolder_1
   |         |________ result_sub_1.xml
   |         |________ subSubFolder
   |                       |______ result_sub_sub_1.xml
   |_____ subFolder_2
             |________ result_sub_2.xml
\end{robotlog}

\begin{itemize}
\item Without \rlog{--recursive}: only \textbf{result\_1.xml} and
      \textbf{result\_2.xml} are found for importing.
\item With \rlog{--recursive}: all \textbf{result\_1.xml}, 
      \textbf{result\_2.xml}, \textbf{result\_sub\_1.xml},
      \textbf{result\_sub\_2.xml} and \textbf{result\_sub\_sub\_1.xml} will
      be imported.
\end{itemize}

\subsection{Create missing Test Case on RQM}
By default, \pkg\ tool will not touch (create, update) any RQM Test Case.

If the \rcode{TCID-xxx} information is missing in \rcode{[Tags]} of Robot Test 
Case, the error message will be raised for that importing Test Case and process
with the next Test Cases
\begin{pythonlog}
ERROR: There is no 'tcid' information for importing test 'Testcase 01'.
\end{pythonlog}

So that, in order to import those missing \rcode{TCID-xxx} Test Cases, the 
optional arugments \rlog{--createmissing} should be provided in the \pkg\
arugments.

When \rlog{--createmissing} is used, \pkg\ will help to create RQM Test Cases 
bases on the defined information in Robot Test Cases first to get the new 
testcase ID and use it for linking to related RQM resources \textbf{TCER}, 
\textbf{Test Case Execution Result} as basic feature.

The new testcase IDs for new Test Cases are also printed in the execution log,
so that you can copy them and update to \rcode{TCID-xxx} information of Robot 
Test Cases for the next Robot execution. Then they will be available in the 
generated \emph{*.xml} result file for importing. 

Please refer \hyperref[description-robot-testcase-information-on-rqm]
{Robot Testcase information on RQM} section for the reflections of defined 
information in Robot Test Case on RQM.

\subsection{Update existing Test Case on RQM}
In case the Test Case is existing on RQM, but you want to update its attribute(s)
such as \textbf{Component}, \textbf{Description}, ... the optional argument
\rlog{--updatetestcase} should be used.

\pkg\ will update RQM Test Case resource bases on the defined information in 
Robot Test Case before creating its result.

Please refer \hyperref[description-robot-testcase-information-on-rqm]{Robot Testcase information on RQM}
section for the reflections of defined information in Robot Test Case on RQM.

\hypertarget{description-robot-testcase-information-on-rqm}{%
\section{Robot Testcase information onRQM:}
\label{description-robot-testcase-information-on-rqm}}
For more detail about the mapping between the defined information from Robot 
Test Case to Robot result (\emph{output.xml}) file and their reflections on 
RQM WebApp, please refer be mapping table:

\begin{table}[h]
   \label{table:RobotLog2RQM-mapping}
   \begin{tabular}{|p{0.115\linewidth}|p{0.12\linewidth}|p{0.31\linewidth}|p{0.45\linewidth}|}
      \hline
      \multicolumn{2}{|c|}{\textbf{RQM data}}
                                      &\multicolumn{2}{|c|}{\textbf{\rfwcore}}\\
      \hline
      \textbf{Resource} &\textbf{Attribute/ Field}
                                      &\textbf{Testsuite/Testcase}   
                                                    &\textbf{Output.xml}\\
      \hline
      Build Record      &Title        &\rcode{Metadata version_sw Build}   
                                                    &\textbf{//suite/metadata/item[@name="version\_sw"]}\\
      \hline
      Test Environment  &Title        &\rcode{Metadata project Environment} 
                                                    &\textbf{//suite/metadata/item[@name="project"]}\\
      \hline
      \multirow{8}{*}{\textbf{Test Case}} 
                        &ID           &\rcode{[Tags] tcid-xxx} 
                                                    &\textbf{//suite/test/tags/tag[@text="tcid-xxx"]}\\
                        \cline{2-4}
                        &Name         &tesname      &\textbf{//suite/test/@name}\\
                        \cline{2-4}
                        &Team Area    &\rcode{Metadata team-area Team_Area} 
                                                    &\textbf{//suite/metadata/item[@name="team-area"]}\\
                        \cline{2-4}
                        &Description  &test doc - \rcode{[Documentation]}
                                                    &\textbf{//suite/test/doc/@text}\\
                        \cline{2-4}
                        &Owner        &provided \rlog{user} in cli  
                                                    &\\
                        \cline{2-4}
                        &Component/ Categories 
                                      &\rcode{Metadata component Component}
                                                    &\textbf{//suite/metadata/item[@name="component"]}\\
                        \cline{2-4}
                        &Requirement ID 
                                      &\rcode{[Tags] fid-yyy}  
                                                    &\textbf{//suite/test/tags/tag[@text="fid-yyy"]}\\
                        \cline{2-4}
                        &Robot File   &\rcode{[Tags] robotfile-zzz}   
                                                    &\textbf{//suite/test/tags/tag[@text="robotfile-zzz"]}\\
      \hline
      \multirow{8}{\linewidth}{\textbf{Test Case Execution Record (TCER)}}
                        &Owner        &provided \rlog{user} in cli  
                                                    &\\
                        \cline{2-4}
                        &Team Area    &\rcode{Metadata team-area Team_Area} 
                                                    &\textbf{//suite/metadata/item[@name="team-area"]}\\
                        \cline{2-4}
                        &Test Plan    &Interaction URL to provided \rlog{testplan} in cli
                                                    &\\
                        \cline{2-4}
                        &Test Case    &Interaction URL to provided testcase ID: 
                                      provided tcid in \rcode{[Tags]: tcid-xxx} or
                                      generated tcid when using \rlog{-createmissing}
                                                    &\textbf{//suite/test/tags/tag[@text="tcid-xxx"]}\\
                        \cline{2-4}
                        &Test Environment  
                                      &\rcode{Metadata project Environment} 
                                                    &\textbf{//suite/metadata/item[@name="project"]}\\
      \hline
      \multirow{13}{\linewidth}{\textbf{Test Result }}
                        &Owner        &provided \rlog{user} in cli  
                                                    &\\
                        \cline{2-4}
                        &Tested By    &provided \rlog{user} in cli - userid must be used
                                                    &\\
                        \cline{2-4}
                        &Team Area    &\rcode{Metadata team-area Team_Area}
                                                    &\textbf{//suite/metadata/item[@name="team-area"]}\\
                        \cline{2-4}
                        &Actual Result&Test case result (\ifpassed{PASSED}, \iffailed{FAILED}, \ifunknown{UNKNOWN})
                                                    &\textbf{//suite/test/status/@status}\\
                        \cline{2-4}
                        &Host Name    &\begin{robotcode}
  Metadata machine %{COMPUTERNAME}
\end{robotcode}
                                                    &\textbf{//suite/metadata/item[@name="machine"]}\\
                        \cline{2-4}
                        &Test Plan    &Interaction URL to provided \rlog{testplan} in cli
                                                    &\\
                        \cline{2-4}
                        &Test Case    &Interaction URL to provided testcase ID: 
                                      provided tcid in \rcode{[Tags]: tcid-xxx} or
                                      generated tcid when using \rlog{-createmissing}
                                                    &\textbf{//suite/test/tags/tag[@text="tcid-xxx"]}\\
                        \cline{2-4}
                        &Test Case Execution Record 
                                      &Interaction URL to TCER ID
                                                    &\\
                        \cline{2-4}
                        &Build        &\rcode{Metadata version_sw Build}
                                                    &\textbf{//suite/metadata/item[@name="version\_sw"]}\\
                        \cline{2-4}
                        &Start Time   &Test case start time
                                                    &\textbf{//suite/test/status/@starttime}\\
                        \cline{2-4}
                        &End Time     &Test case end time
                                                    &\textbf{//suite/test/status/@endtime}\\
                        \cline{2-4}
                        &Total Run Time
                                      &Calculated from start and end time
                                                    &\\
                        \cline{2-4}
                        &Result Details 
                                      &Test case message log             
                                                    &\textbf{//suite/test/status/@text}\\
                        \cline{2-4}
      \hline
   \end{tabular} 
   \caption{RQM data \& \rfwcore\ testcase/output.xml}
\end{table}
